# 敏感层分析算法

敏感层分析是模型量化过程中的关键步骤，通过评估模型各层对量化的敏感程度，可以帮助开发者决定哪些层应该保持高精度（如 Float16/BFloat16），哪些层可以进行量化（如 INT8/INT4），从而在保证模型精度的前提下实现最优的推理性能。

msModelSlim 提供了多种敏感层分析算法，主要基于激活值的统计特征进行评估。

### 算法说明

#### 1. std (Standard Deviation) - 标准差算法 {#1-std-standard-deviation---标准差算法}

##### 算法原理
- 计算激活值的最大值（max_value）、最小值（min_value）和标准差（std）。
- 使用公式评估敏感得分：
  \[ score = \frac{\max(|max\_value|, |min\_value|)}{std} \]
- 该得分反映了数据的变异程度相对于其量程的大小。

##### 适用场景
- **推荐用于**: 常规量化场景，作为首选的基准评估方法。
- **优势**:
  - 计算开销极低，性能优异。
  - 对数据分布的整体变化非常敏感。
  - 直观地反映了数据的波动性与动态范围的关系。
- **特点**:
  - **标准差越大**：意味着数据分布较散，score 越小，通常表示该层对量化误差的容忍度较高（不敏感）。
  - **动态范围越大**：意味着数据跨度大，score 越大，表示该层在量化时更容易产生较大的截断或舍入误差（敏感）。

#### 2. quantile (Quantile-based) - 分位数算法 {#2-quantile-quantile-based---分位数算法}

##### 算法原理
- 计算激活值的第 1/4 分位数（Q1）和第 3/4 分位数（Q3）。
- 使用公式评估敏感得分：
  \[ score = \frac{2 \times max\_abs}{254 \times (Q3 - Q1)} \]
- 其中 `max_abs` 为激活值绝对值的最大值。该算法基于四分位距（IQR）评估分布特征。

##### 适用场景
- **推荐用于**: 数据分布存在长尾效应或存在少量极端离群值的场景。
- **优势**:
  - **稳健性高**：由于使用了分位数，算法对极少数的异常点（Outliers）不敏感。
  - 能够更真实地反映大部分数据在量化过程中的表现。
- **特点**:
  - **IQR 越大**：表示中间 50% 的数据分布越分散，score 越小，对量化越不敏感。
  - **max_abs 越大**：表示整体量程大，score 越大，对量化越敏感。

#### 3. kurtosis (Kurtosis-based) - 峰度算法 {#3-kurtosis-kurtosis-based---峰度算法}

##### 算法原理
- 计算激活值的峰度（Kurtosis）。
- 峰度公式：
  \[ kurtosis = \frac{E[(X-\mu)^4]}{\sigma^4} - 3 \]
- 峰度衡量了数据分布在均值处的尖锐程度以及尾部的厚度。

##### 适用场景
- **推荐用于**: 需要精准识别激活值分布中极端值影响的场景，或对精度要求极高的精细化量化。
- **优势**:
  - 能有效识别分布的尖峰程度。
  - 对极端值（尾部特征）非常敏感，有助于发现潜在的精度瓶颈层。
- **特点**:
  - **峰度值越大**：表示分布越集中于均值且尾部较厚（尖峰重尾），score 越大，通常认为该层对量化更为敏感。
  - **峰度值越接近 0**：表示分布接近正态分布，score 越小，相对不敏感。

### 如何选择算法

| 需求目标 | 推荐算法 | 理由 |
| :--- | :--- | :--- |
| 快速初步评估 | **std** | 计算最快，覆盖大多数常规分布。 |
| 存在明显离群值 | **quantile** | 排除异常值干扰，关注主体分布。 |
| 追求极致精度保持 | **kurtosis** | 捕捉尾部特征，识别最脆弱的层。 |

> **提示**：在实际操作中，建议结合多种算法的结果进行综合判断。如果某一层在多个算法下均表现为高敏感，则应优先考虑将其设为非量化层。
